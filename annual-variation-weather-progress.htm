<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="description" content="æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã®æ—¥åˆ¥å€¤ã¨å¹³å¹´å€¤ã‚’ã‚°ãƒ©ãƒ•åŒ–ã™ã‚‹ã€‚">
<meta name="author" content="æ¾¤ç”°æ³°äºº">
<meta name="date" content="2025å¹´5æœˆ4æ—¥">
<title>æ°—è±¡çµŒé</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@latest"></script>
<style>
@media print {
  * {
    margin: 0;
    padding: 0;
  }
  input, button, select, label, form, h5, h3 {
    display: none !important;
  }
}
button {
  background-color: #4CAF50;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: right;
}
form {
  flex: 1;
  margin: 20px;
  padding: 40px;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  width: 200px;
}
h1 {
  background-color: #4CAF50;
  color: white;
  padding: 10px;
  text-align: center;
}
label {
  display: flex;
  align-items: center;
  gap: 8px;
}
.chart-container {
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}
canvas {
  width: 100% !important;
  height: auto !important;
}
.container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: flex-start;
}
.right-align {
  text-align: right;
}
.table-container, .chart-container {
  flex: 1;
  min-width: 300px;
}
input[type="date"], input[type="file"], input[type="number"] {
  width: 150px;
  padding: 8px 10px;
  font-size: 16px;
  margin-bottom: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
.GraphupdateButton {
  background-color: #4CAF50;
  color: white;
  padding: 8px 12px;
  font-size: 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-left: 4px;
}
#chartcanvas {
  width: 80%;
  height: auto;
  padding: 10px;
  position: absolute;
  right: 100px;
}
#loadingOverlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.8);
  z-index: 9999;
  text-align: center;
  padding-top: 20%;
  font-size: 2em;
  color: #333;
}
</style>
</head>
<body>
<h1 id="mainTitle">æ°—è±¡çµŒéã€€å‡ºé›²</h1>

<div class="right-align">
  <button onclick="window.open('https://www.data.jma.go.jp/gmd/risk/obsdl/index.php', '_blank')">æ°—è±¡åºã®ã‚µã‚¤ãƒˆã‚’é–‹ã</button>
</div>
<br>
<button id="updateButton" type="button" disabled>æ›´æ–°</button>
<span id="csvDates"></span>

<div class="container">
  <form onsubmit="return false;">
    <label for="cultivationStartDate">é–‹å§‹æ—¥:</label>
    <input type="date" id="cultivationStartDate">
    <label for="cultivationEndDate">çµ‚äº†æ—¥ï¼ˆæœ€çµ‚æ—¥ï¼‰:</label>
    <input type="date" id="cultivationEndDate">
  </form>
</div>

<div id="chartcanvas" style="margin-top: 5em; display: none;">
  <h3>æ—¥ãƒ‡ãƒ¼ã‚¿</h3>
  <div style="margin-bottom: 3em;">
    <label>
      ç¸¦è»¸æœ€å¤§å€¤ï¼ˆæ°—æ¸©ï¼‰:
      <input type="number" id="tempMax" value="40" step="5" placeholder="ä¾‹: 40">
    </label>
    <button type="button" class="GraphupdateButton" onclick="handleGraphUpdate()">ã‚°ãƒ©ãƒ•æ›´æ–°</button>
    <canvas id="dailyTempChart"></canvas>
  </div>
  <div style="margin-bottom: 3em;">
    <label>
      ç¸¦è»¸æœ€å¤§å€¤ï¼ˆé™æ°´é‡ï¼‰:
      <input type="number" id="precMax" value="100" step="10" placeholder="ä¾‹: 100">
    </label>
    <button type="button" class="GraphupdateButton" onclick="handleGraphUpdate()">ã‚°ãƒ©ãƒ•æ›´æ–°</button>
    <canvas id="dailyPrecChart"></canvas>
  </div>
  <div style="margin-bottom: 3em;">
    <label>
      ç¸¦è»¸æœ€å¤§å€¤ï¼ˆæ—¥ç…§æ™‚é–“ï¼‰è¦³æ¸¬ã‚’å®Ÿæ–½ã™ã‚‹åœ°ç‚¹ã®ã¿:
      <input type="number" id="sunMax" value="16" step="2" placeholder="ä¾‹: 15">
    </label>
    <button type="button" class="GraphupdateButton" onclick="handleGraphUpdate()">ã‚°ãƒ©ãƒ•æ›´æ–°</button>
    <canvas id="dailySunChart"></canvas>
  </div>
</div>

<div id="loadingOverlay">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script>
let csvData = [];
const updateBtn = document.getElementById('updateButton');
const overlay = document.getElementById('loadingOverlay');

async function loadCSVAndRender() {
  try {
    overlay.style.display = 'block';
    const res = await fetch('å‡ºé›²æ—¥åˆ¥å€¤.csv');
    const buf = await res.arrayBuffer();
    const content = shiftJISToUTF8(buf);
    csvData = parseCSV(content);
    if (csvData.length > 0) {
      const dates = csvData.map(d => d.date).sort((a,b)=>a-b);
      const min = dates[0];
      const max = dates[dates.length-1];
      document.getElementById('csvDates').textContent = `CSVæ—¥ä»˜ç¯„å›²: ${min.toISOString().slice(0,10)} ï½ ${max.toISOString().slice(0,10)}`;
      updateDateFields();
      updateMainTitle();
      updateBtn.disabled = false;
      handleGraphUpdate();
    } else {
      alert('CSVã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
    }
  } catch (e) {
    alert('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼š' + e);
  } finally {
    overlay.style.display = 'none';
  }
}

function handleGraphUpdate() {
  if (!csvData.length) return;

  const s = document.getElementById('cultivationStartDate').value;
  const e = document.getElementById('cultivationEndDate').value;
  if (!s || !e) {
    alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  const startDate = new Date(s);
  const endDate = new Date(e);
  if (isNaN(startDate) || isNaN(endDate)) {
    alert('æ—¥ä»˜ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  if (startDate > endDate) {
    alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„');
    return;
  }

  overlay.style.display = 'block';

  // ğŸ”§ ä¿®æ­£ï¼šéåŒæœŸé–¢æ•°ã§ç¢ºå®Ÿã« overlay ã‚’é–‰ã˜ã‚‹
  (async () => {
    try {
      const avgStart = new Date(startDate);
      avgStart.setFullYear(avgStart.getFullYear() - 1);
      const avgEnd = new Date(avgStart);
      avgEnd.setDate(avgEnd.getDate() + 364);
      const min = avgStart < startDate ? avgStart : startDate;
      const max = avgEnd > endDate ? avgEnd : endDate;

      const filtered = filterData(csvData, min, max);
      const chartData = prepareComparisonData(filtered, startDate, endDate);
      updateDailyCharts(chartData);

      document.getElementById('chartcanvas').style.display = 'block';
      updateMainTitle();
    } catch (e) {
      alert('ã‚°ãƒ©ãƒ•æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š\n' + e);
      console.error(e);
    } finally {
      overlay.style.display = 'none'; // âœ… ã“ã“ã§ç¢ºå®Ÿã«èª­ã¿è¾¼ã¿ä¸­ã‚’æ¶ˆã™
    }
  })();
}


function updateMainTitle() {
  const s = document.getElementById('cultivationStartDate').value;
  const e = document.getElementById('cultivationEndDate').value;
  if (s && e) {
    const sy = new Date(s).getFullYear();
    const ey = new Date(e).getFullYear();
    document.getElementById('mainTitle').textContent = `${sy}å¹´-${ey}å¹´ã€€æ°—è±¡çµŒé`;
  }
}

function updateDateFields() {
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,'0');
  const dd = String(now.getDate()).padStart(2,'0');
  document.getElementById('cultivationStartDate').value = `${yyyy}-01-01`;
  document.getElementById('cultivationEndDate').value = `${yyyy}-${mm}-${dd}`;
}

// ä»¥ä¸‹ã€å…ƒã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤ï¼ˆå¤‰æ›´ãªã—ï¼‰

function shiftJISToUTF8(arrayBuffer) {
  const decoder = new TextDecoder('shift-jis');
  const uint8Array = new Uint8Array(arrayBuffer);
  return decoder.decode(uint8Array);
}

function parseCSV(content) {
  const lines = content.trim().split('\n').filter(line => line.trim() !== "");
  let lines1 = lines[2].split(',');
  let lines2 = lines[3].split(',');
  let lines3 = lines[4].split(',');
  let combinedHead = [];
  for (let i = 0; i < lines1.length; i++) {
    combinedHead.push(lines1[i].replace(/\r/g, '') + lines2[i].replace(/\r/g, '') + lines3[i].replace(/\r/g, ''));
  }
  const targetHeaders = ["å¹´","æœˆ","æ—¥","å¹³å‡æ°—æ¸©(â„ƒ)","é™æ°´é‡ã®åˆè¨ˆ(mm)","æ—¥ç…§æ™‚é–“(æ™‚é–“)",
    "å¹³å‡æ°—æ¸©(â„ƒ)å¹³å¹´å€¤(â„ƒ)","é™æ°´é‡ã®åˆè¨ˆ(mm)å¹³å¹´å€¤(mm)","æ—¥ç…§æ™‚é–“(æ™‚é–“)å¹³å¹´å€¤(æ™‚é–“)",
    "æœ€é«˜æ°—æ¸©(â„ƒ)","æœ€ä½æ°—æ¸©(â„ƒ)","æœ€é«˜æ°—æ¸©(â„ƒ)å¹³å¹´å€¤(â„ƒ)","æœ€ä½æ°—æ¸©(â„ƒ)å¹³å¹´å€¤(â„ƒ)"];
  let indicesToSelect = targetHeaders.map(h => combinedHead.findIndex(ch => ch.includes(h)));
  const dataLines = lines.slice(6).map(line => {
    const cols = line.split(',');
    const sel = indicesToSelect.map(idx => idx >= 0 ? cols[idx] || '0' : '0');
    return sel.join(',');
  });
  dataLines.unshift(targetHeaders.join(','));
  return dataLines.slice(1).map(line => {
    const cols = line.split(',');
    return {
      date: new Date(Date.UTC(cols[0], cols[1]-1, cols[2])),
      temperature: parseFloat(cols[3])||0,
      precipitation: parseFloat(cols[4])||0,
      sunshine: parseFloat(cols[5])||0,
      avgTemperature: parseFloat(cols[6])||0,
      avgPrecipitation: parseFloat(cols[7])||0,
      avgSunshine: parseFloat(cols[8])||0,
      maxTemperature: parseFloat(cols[9])||0,
      minTemperature: parseFloat(cols[10])||0,
      avgMaxTemperature: parseFloat(cols[11])||0,
      avgMinTemperature: parseFloat(cols[12])||0
    };
  });
}

function filterData(data, start, end) {
  return data.filter(d => d.date >= start && d.date <= end);
}

function prepareComparisonData(data, startDate, endDate) {
  const dailyMap = {}, avgMap = {};
  data.forEach(d => {
    const key = `${d.date.getMonth()+1}-${d.date.getDate()}`;
    if (d.date >= startDate && d.date <= endDate) {
      dailyMap[key] = { temperature: d.temperature, precipitation: d.precipitation, sunshine: d.sunshine,
        maxTemperature: d.maxTemperature, minTemperature: d.minTemperature };
    }
    if (!isNaN(d.avgTemperature)) avgMap[key] = avgMap[key]||{}, avgMap[key].temperature = d.avgTemperature;
    if (!isNaN(d.avgPrecipitation)) avgMap[key] = avgMap[key]||{}, avgMap[key].precipitation = d.avgPrecipitation;
    if (!isNaN(d.avgSunshine)) avgMap[key]    = avgMap[key]||{}, avgMap[key].sunshine = d.avgSunshine;
    if (!isNaN(d.avgMaxTemperature)) avgMap[key] = avgMap[key]||{}, avgMap[key].maxTemperature = d.avgMaxTemperature;
    if (!isNaN(d.avgMinTemperature)) avgMap[key] = avgMap[key]||{}, avgMap[key].minTemperature = d.avgMinTemperature;
  });

  const labels = [], dailyTemps = [], avgTemps = [], dailyPrecs = [], avgPrecs = [],
        dailySuns = [], avgSuns = [], dailyMaxTemps = [], avgMaxTemps = [], dailyMinTemps = [], avgMinTemps = [];

  const current = new Date(startDate);
  while (current <= endDate) {
    const md = `${String(current.getFullYear()).slice(-2)}-${current.getMonth()+1}-${current.getDate()}`;
    labels.push(md);
    const d = dailyMap[`${current.getMonth()+1}-${current.getDate()}`];
    const a = avgMap[`${current.getMonth()+1}-${current.getDate()}`];

    dailyTemps.push(d ? d.temperature : null);
    avgTemps.push(a ? a.temperature : null);
    dailyPrecs.push(d ? d.precipitation : null);
    avgPrecs.push(a ? a.precipitation : null);
    dailySuns.push(d ? d.sunshine : null);
    avgSuns.push(a ? a.sunshine : null);
    dailyMaxTemps.push(d ? d.maxTemperature : null);
    avgMaxTemps.push(a ? a.maxTemperature : null);
    dailyMinTemps.push(d ? d.minTemperature : null);
    avgMinTemps.push(a ? a.minTemperature : null);

    current.setDate(current.getDate()+1);
  }

  return {
    labels,
    temperature: { daily: dailyTemps, avg: avgTemps },
    precipitation: { daily: dailyPrecs, avg: avgPrecs },
    sunshine: { daily: dailySuns, avg: avgSuns },
    maxTemperature: { daily: dailyMaxTemps, avg: avgMaxTemps },
    minTemperature: { daily: dailyMinTemps, avg: avgMinTemps }
  };
}

let dailyTempChart, dailyPrecChart, dailySunChart;
function updateDailyCharts(chartData) {
  const { labels, temperature, maxTemperature, minTemperature, precipitation, sunshine } = chartData;

  let maxTempValue = parseFloat(document.getElementById('tempMax').value);
  let maxPrecValue = parseFloat(document.getElementById('precMax').value);
  let maxSunValue = parseFloat(document.getElementById('sunMax').value);
  if (isNaN(maxTempValue)) maxTempValue = 40;
  if (isNaN(maxPrecValue)) maxPrecValue = 100;
  if (isNaN(maxSunValue)) maxSunValue = 16;

  const createChart = (ctx, type, labels, datasets, yMax) => {
    return new Chart(ctx, {
      type,
      data: { labels, datasets },
      options: {
        layout: { padding: { left: 20, right: 20, top: 20, bottom: 20 }},
        plugins: { legend: { labels: { font: { size: 30 }}}},
        scales: {
          x: { ticks: { font: { size: 28 }}, title: { display: true, text: 'å¹´ã®ä¸‹2æ¡-æœˆ-æ—¥', font: { size: 30 }}},
          y: { ticks: { font: { size: 28 }}, title: { display: true, text: '', font: { size: 30 }}, suggestedMax: yMax }
        }
      }
    });
  };

  if (dailyTempChart) dailyTempChart.destroy();
  dailyTempChart = createChart(
    document.getElementById('dailyTempChart').getContext('2d'),
    'line', labels, [
      { label: 'æ—¥ã€…ã®å¹³å‡æ°—æ¸©(â„ƒ)', data: temperature.daily, borderColor: 'rgba(255,165,0,1)', borderWidth: 3, fill: false },
      { label: 'å¹³å¹´å€¤æ°—æ¸©(â„ƒ)', data: temperature.avg, borderColor: 'rgba(255,165,0,0.5)', borderDash: [5,5], borderWidth: 2, fill: false },
      { label: 'æ—¥ã€…ã®æœ€é«˜æ°—æ¸©(â„ƒ)', data: maxTemperature.daily, borderColor: 'rgba(255,99,132,1)', borderWidth: 3, fill: false },
      { label: 'å¹³å¹´å€¤æœ€é«˜æ°—æ¸©(â„ƒ)', data: maxTemperature.avg, borderColor: 'rgba(255,99,132,0.5)', borderDash: [5,5], borderWidth: 2, fill: false },
      { label: 'æ—¥ã€…ã®æœ€ä½æ°—æ¸©(â„ƒ)', data: minTemperature.daily, borderColor: 'rgba(54,162,235,1)', borderWidth: 3, fill: false },
      { label: 'å¹³å¹´å€¤æœ€ä½æ°—æ¸©(â„ƒ)', data: minTemperature.avg, borderColor: 'rgba(54,162,235,0.5)', borderDash: [5,5], borderWidth: 2, fill: false }
    ], maxTempValue
  );

  if (dailyPrecChart) dailyPrecChart.destroy();
  dailyPrecChart = createChart(
    document.getElementById('dailyPrecChart').getContext('2d'),
    'bar', labels, [
      { label: 'æ—¥ã€…ã®é™æ°´é‡(mm)', data: precipitation.daily, backgroundColor: 'rgba(54,162,235,1)', maxBarThickness: 10 },
      { label: 'å¹³å¹´å€¤é™æ°´é‡(mm)', data: precipitation.avg, type: 'line', borderColor: 'rgba(100,100,100,1)', borderDash: [4,4], borderWidth: 2, fill: false }
    ], maxPrecValue
  );

  if (dailySunChart) dailySunChart.destroy();
  dailySunChart = createChart(
    document.getElementById('dailySunChart').getContext('2d'),
    'bar', labels, [
      { label: 'æ—¥ã€…ã®æ—¥ç…§æ™‚é–“(æ™‚é–“)', data: sunshine.daily, backgroundColor: 'rgba(255,206,86,1)', maxBarThickness: 10 },
      { label: 'å¹³å¹´å€¤æ—¥ç…§æ™‚é–“(æ™‚é–“)', data: sunshine.avg, type: 'line', borderColor: 'rgba(150,150,150,1)', borderDash: [4,4], borderWidth: 2, fill: false }
    ], maxSunValue
  );
}

// ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
window.addEventListener('DOMContentLoaded', loadCSVAndRender);
updateBtn.addEventListener('click', handleGraphUpdate);
document.getElementById('cultivationStartDate').addEventListener('change', () => { updateMainTitle(); handleGraphUpdate(); });
document.getElementById('cultivationEndDate').addEventListener('change', () => { updateMainTitle(); handleGraphUpdate(); });
</script>
</body>
</html>

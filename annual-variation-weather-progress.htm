<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="description" content="気象データの日別値と平年値をグラフ化する。">  
<meta name="author" content="澤田泰人">
<meta name="date" content="2025年5月4日">
<meta charset="UTF-8">
<title>気象経過</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@latest"></script>
<style>
/* 印刷用の設定 */
@media print {
  * {
    margin: 0;
    padding: 0;
  }
  input,
  button,
  select,
  label,
  form,
  h5,
  h3 {
    display: none !important;
  }
}
button {
  background-color: #4CAF50;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: right;
}
form {
  flex: 1;
  margin: 20px;
  padding: 40px;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  width: 200px;
}
h1 {
  background-color: #4CAF50;
  color: white;
  padding: 10px;
  text-align: center;
}
label {
  display: flex;
  align-items: center;
  gap: 8px;
}
.chart-container {
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}
canvas {
  width: 100% !important;
  height: auto !important;
}
.container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: flex-start;
}
.right-align {
  text-align: right;
}
.table-container, .chart-container {
  flex: 1;
  min-width: 300px;
}
input[type="date"], input[type="file"], input[type="number"] {
  width: 150px;
  padding: 8px 10px;
  font-size: 16px;
  margin-bottom: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
.GraphupdateButton {
  background-color: #4CAF50;
  color: white;
  padding: 8px 12px;
  font-size: 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-left: 4px;
}
#chartcanvas {
  width: 80%;
  height: auto;
  padding: 10px;
  position: absolute;
  right: 100px;
}
</style>
</head>
<body>
<h1 id="mainTitle">気象経過　出雲</h1>

<div class="right-align">
    <button onclick="window.open('https://www.data.jma.go.jp/gmd/risk/obsdl/index.php', '_blank')">気象庁のサイトを開く</button>
</div>
<br>
<span id="csvDates"></span>
<button id="updateButton" type="button">更新</button>
<div class="container">
    <form onsubmit="return false;">
        <label for="cultivationStartDate">開始日:</label>
        <input type="date" id="cultivationStartDate">
        <label for="cultivationEndDate">終了日（最終日）:</label>
        <input type="date" id="cultivationEndDate">
    </form>
</div>
<div id="chartcanvas" style="margin-top: 5em; display: none;">
<h3>日データ</h3>
<div style="margin-bottom: 3em;">
  <label>
    縦軸最大値（気温）:
    <input type="number" id="tempMax" value="40" step="5" placeholder="例: 40">
  </label>
  <button type="button" class="GraphupdateButton" onclick="handleGraphUpdate()">グラフ更新</button>
  <canvas id="dailyTempChart"></canvas>
</div>
<div style="margin-bottom: 3em;">
  <label>
    縦軸最大値（降水量）:
    <input type="number" id="precMax" value="100" step="10" placeholder="例: 100">
  </label>
  <button type="button" class="GraphupdateButton" onclick="handleGraphUpdate()">グラフ更新</button>
  <canvas id="dailyPrecChart"></canvas>
</div>
<div style="margin-bottom: 3em;">
  <label>
    縦軸最大値（日照時間）観測を実施する地点のみ:
    <input type="number" id="sunMax" value="16"  step="2" placeholder="例: 15">
  </label>
  <button type="button" class="GraphupdateButton" onclick="handleGraphUpdate()">グラフ更新</button>
  <canvas id="dailySunChart"></canvas>
</div>
</div>
<script>
let csvData = []; // グローバル保持

async function loadCSVAndRender() {
    const response = await fetch('出雲日別値.csv');
    const arrayBuffer = await response.arrayBuffer();
    const utf8Content = shiftJISToUTF8(arrayBuffer);
    csvData = parseCSV(utf8Content);

    if (csvData.length > 0) {
        const dates = csvData.map(d => d.date).sort((a, b) => a - b);
        const minDate = dates[0], maxDate = dates[dates.length - 1];
        document.getElementById("csvDates").textContent =
            `CSV日付範囲: ${minDate.getFullYear()}-${minDate.getMonth()+1}-${minDate.getDate()} ～ ${maxDate.getFullYear()}-${maxDate.getMonth()+1}-${maxDate.getDate()}`;
    }

    updateDateFields();
    updateMainTitle();
    handleGraphUpdate();
}

function handleGraphUpdate() {
    console.log("handleGraphUpdate 開始");

    if (!csvData || csvData.length === 0) return;

    const startDateInput = document.getElementById("cultivationStartDate").value;
    const endDateInput = document.getElementById("cultivationEndDate").value;

    if (!startDateInput || !endDateInput) {
        alert("開始日と終了日を入力してください。");
        return;
    }

    const startDate = new Date(startDateInput);
    const endDate = new Date(endDateInput);

    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
        alert("日付の形式が正しくありません。");
        return;
    }

    if (startDate > endDate) {
        alert("開始日は終了日より前の日付を選んでください。");
        return;
    }

    const avgStart = new Date(startDate);
    avgStart.setFullYear(avgStart.getFullYear() - 1);
    const avgEnd = new Date(avgStart);
    avgEnd.setDate(avgEnd.getDate() + 364);
    const minDate = new Date(Math.min(startDate, avgStart));
    const maxDate = new Date(Math.max(endDate, avgEnd));

    const filteredData = filterData(csvData, minDate, maxDate);
    console.log("filteredData 件数:", filteredData.length);

    const chartData = prepareComparisonData(filteredData, startDate, endDate);
    console.log("chartData labels:", chartData.labels.length);

    updateDailyCharts(chartData);
    document.getElementById("chartcanvas").style.display = "block";
    updateMainTitle();
}

function updateMainTitle() {
    const startDate = document.getElementById("cultivationStartDate").value;
    const endDate = document.getElementById("cultivationEndDate").value;
    if (startDate && endDate) {
        const startYear = new Date(startDate).getFullYear();
        const endYear = new Date(endDate).getFullYear();
        const title = `${startYear}年-${endYear}年　気象経過`;
        document.getElementById("mainTitle").textContent = title;
    }
}

function updateDateFields() {
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = String(currentDate.getMonth()+1).padStart(2, '0');
    const currentDay = String(currentDate.getDate()).padStart(2, '0');
    document.getElementById('cultivationStartDate').value = `${currentYear}-01-01`;
    document.getElementById('cultivationEndDate').value = `${currentYear}-${currentMonth}-${currentDay}`;
}

window.addEventListener('DOMContentLoaded', loadCSVAndRender);
document.getElementById('updateButton').addEventListener('click', handleGraphUpdate);
document.getElementById("cultivationStartDate").addEventListener("change", () => {
    updateMainTitle();
    handleGraphUpdate();
});
document.getElementById("cultivationEndDate").addEventListener("change", () => {
    updateMainTitle();
    handleGraphUpdate();
});

function shiftJISToUTF8(arrayBuffer) {
    const decoder = new TextDecoder('shift-jis');
    const uint8Array = new Uint8Array(arrayBuffer);
    return decoder.decode(uint8Array);
}

function parseCSV(content) {
    const lines = content.trim().split('\n').filter(line => line.trim() !== "");
    let lines1 = lines[2].split(',');
    let lines2 = lines[3].split(',');
    let lines3 = lines[4].split(',');
    let combinedHead = [];
    for (let i = 0; i < lines1.length; i++) {
        combinedHead.push(lines1[i].replace(/\r/g, '') + lines2[i].replace(/\r/g, '') + lines3[i].replace(/\r/g, ''));
    }

    const targetHeaders = ["年", "月", "日", "平均気温(℃)", "降水量の合計(mm)", "日照時間(時間)",
        "平均気温(℃)平年値(℃)", "降水量の合計(mm)平年値(mm)", "日照時間(時間)平年値(時間)",
        "最高気温(℃)", "最低気温(℃)", "最高気温(℃)平年値(℃)", "最低気温(℃)平年値(℃)"];

    let indicesToSelect = targetHeaders.map(header => combinedHead.findIndex(h => h.includes(header)));
    const dataLines = lines.slice(6).map(line => {
        const cols = line.split(',');
        const selectedCols = indicesToSelect.map(index => index >= 0 ? cols[index] || '0' : '0');
        return selectedCols.join(',');
    });
    dataLines.unshift(targetHeaders.join(','));

    return dataLines.slice(1).map(line => {
        const cols = line.split(",");
        return {
            date: new Date(Date.UTC(cols[0], cols[1]-1, cols[2])),
            temperature: parseFloat(cols[3]) || 0,
            precipitation: parseFloat(cols[4]) || 0,
            sunshine: parseFloat(cols[5]) || 0,
            avgTemperature: parseFloat(cols[6]) || 0,
            avgPrecipitation: parseFloat(cols[7]) || 0,
            avgSunshine: parseFloat(cols[8]) || 0,
            maxTemperature: parseFloat(cols[9]) || 0,
            minTemperature: parseFloat(cols[10]) || 0,
            avgMaxTemperature: parseFloat(cols[11]) || 0,
            avgMinTemperature: parseFloat(cols[12]) || 0
        };
    });
}

function filterData(data, graphStart, graphEnd) {
    return data.filter(d => d.date >= graphStart && d.date <= graphEnd);
}

function prepareComparisonData(data, startDate, endDate) {
    const dailyMap = {}, avgMap = {};
    data.forEach(d => {
        const dateKey = `${d.date.getMonth() + 1}-${d.date.getDate()}`;
        if (d.date >= startDate && d.date <= endDate) {
            dailyMap[dateKey] = {
                temperature: d.temperature,
                precipitation: d.precipitation,
                sunshine: d.sunshine,
                maxTemperature: d.maxTemperature,
                minTemperature: d.minTemperature
            };
        }
        if (!isNaN(d.avgTemperature)) {
            avgMap[dateKey] = avgMap[dateKey] || {};
            avgMap[dateKey].temperature = d.avgTemperature;
        }
        if (!isNaN(d.avgPrecipitation)) {
            avgMap[dateKey] = avgMap[dateKey] || {};
            avgMap[dateKey].precipitation = d.avgPrecipitation;
        }
        if (!isNaN(d.avgSunshine)) {
            avgMap[dateKey] = avgMap[dateKey] || {};
            avgMap[dateKey].sunshine = d.avgSunshine;
        }
        if (!isNaN(d.avgMaxTemperature)) {
            avgMap[dateKey] = avgMap[dateKey] || {};
            avgMap[dateKey].maxTemperature = d.avgMaxTemperature;
        }
        if (!isNaN(d.avgMinTemperature)) {
            avgMap[dateKey] = avgMap[dateKey] || {};
            avgMap[dateKey].minTemperature = d.avgMinTemperature;
        }
    });

    const labels = [], dailyTemps = [], avgTemps = [], dailyPrecs = [], avgPrecs = [],
        dailySuns = [], avgSuns = [], dailyMaxTemps = [], avgMaxTemps = [], dailyMinTemps = [], avgMinTemps = [];

    const current = new Date(startDate);
    const endCurrent = new Date(endDate);

    while (current <= endCurrent) {
        const yearTwoDigits = String
     </script>
</body>
</html>
